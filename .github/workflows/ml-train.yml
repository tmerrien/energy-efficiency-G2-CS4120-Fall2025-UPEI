name: ML Training & Evaluation

on:
  pull_request:
    branches: [ main, midpoint ]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - '.github/workflows/ml-train.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  train-and-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install matplotlib seaborn
        
    - name: Create output directories
      run: |
        mkdir -p outputs/models
        mkdir -p outputs/plots
        mkdir -p outputs/metrics
        
    - name: Train models and generate metrics
      run: |
        # This is a placeholder - replace with your actual training script
        echo "Training models..."
        python -m src.preview_targets > outputs/metrics/data_summary.txt
        
        # Create a sample metrics file for CML
        cat > outputs/metrics/results.txt << EOF
        ## Model Training Results
        
        ### Classification Task
        - **Logistic Regression**
          - Validation Accuracy: TBD
          - Validation F1: TBD
          - Test Accuracy: TBD
          - Test F1: TBD
        
        - **Decision Tree**
          - Validation Accuracy: TBD
          - Validation F1: TBD
          - Test Accuracy: TBD
          - Test F1: TBD
        
        ### Regression Task
        - **Linear Regression**
          - Validation MAE: TBD
          - Validation RMSE: TBD
          - Test MAE: TBD
          - Test RMSE: TBD
        
        - **Decision Tree Regressor**
          - Validation MAE: TBD
          - Validation RMSE: TBD
          - Test MAE: TBD
          - Test RMSE: TBD
        EOF
        
    - name: Setup CML
      uses: iterative/setup-cml@v2
      
    - name: Create CML report
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create markdown report
        cat outputs/metrics/results.txt >> report.md
        echo "" >> report.md
        echo "### Data Summary" >> report.md
        cat outputs/metrics/data_summary.txt >> report.md
        
        # Post report as PR comment
        cml comment create report.md
